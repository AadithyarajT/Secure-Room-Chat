<!-- templates/private_room_password.html -->
{% extends "base.html" %}

{% block title %}Private Room Access - SimpleChat{% endblock %}

{% block page_title %}Private Room Access{% endblock %}

{% block extra_css %}
<style>
    .password-container {
        max-width: 500px;
        margin: 0 auto;
        padding: 40px 0;
    }
    
    .password-card {
        background: white;
        border-radius: 15px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        overflow: hidden;
        border: 1px solid #e9ecef;
    }
    
    .password-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 40px 30px;
        text-align: center;
    }
    
    .password-icon {
        font-size: 64px;
        margin-bottom: 20px;
    }
    
    .password-title {
        font-size: 28px;
        font-weight: bold;
        margin-bottom: 10px;
    }
    
    .password-subtitle {
        font-size: 16px;
        opacity: 0.9;
    }
    
    .password-body {
        padding: 40px;
    }
    
    .room-info {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 25px;
        border-left: 4px solid #4CAF50;
    }
    
    .room-info h3 {
        color: #2c3e50;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .room-details {
        color: #6c757d;
        font-size: 14px;
    }
    
    .room-details p {
        margin: 5px 0;
    }
    
    .creator-notice {
        background: #d4edda;
        color: #155724;
        padding: 12px;
        border-radius: 6px;
        margin-top: 10px;
        font-weight: 500;
    }
    
    .logged-in-notice {
        color: #4CAF50;
        margin-top: 10px;
        font-weight: 500;
    }
    
    .guest-notice {
        color: #f39c12;
        margin-top: 10px;
        font-weight: 500;
    }
    
    .password-form .form-group {
        margin-bottom: 25px;
    }
    
    .form-label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #2c3e50;
        font-size: 15px;
    }
    
    .form-input {
        width: 100%;
        padding: 14px 16px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 16px;
        transition: all 0.3s;
        background: #f8f9fa;
    }
    
    .form-input:focus {
        border-color: #4CAF50;
        background: white;
        outline: none;
        box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
    }
    
    .form-input.error {
        border-color: #e74c3c;
        background: #fff5f5;
    }
    
    .error-message {
        color: #e74c3c;
        font-size: 14px;
        margin-top: 10px;
        padding: 12px;
        background: #ffeaea;
        border-radius: 6px;
        border-left: 4px solid #e74c3c;
        display: flex;
        align-items: center;
        gap: 10px;
        animation: fadeIn 0.3s ease;
    }
    
    .password-btn {
        width: 100%;
        padding: 16px;
        background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s;
        margin-top: 10px;
    }
    
    .password-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
    }
    
    .password-btn:active {
        transform: translateY(0);
    }
    
    .remember-checkbox {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-top: 15px;
        cursor: pointer;
    }
    
    .remember-checkbox input {
        width: 18px;
        height: 18px;
        cursor: pointer;
    }
    
    .remember-label {
        color: #6c757d;
        font-size: 14px;
    }
    
    .alternative-options {
        text-align: center;
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid #e9ecef;
    }
    
    .alternative-options a {
        color: #4CAF50;
        text-decoration: none;
        font-weight: 600;
        margin: 0 10px;
    }
    
    .alternative-options a:hover {
        text-decoration: underline;
    }
    
    /* Loading animation */
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .loading-spinner {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: white;
        animation: spin 1s linear infinite;
        margin-right: 8px;
    }
    
    /* Password container */
    .password-container-field {
        position: relative;
    }
    
    .toggle-password-btn {
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        color: #6c757d;
        cursor: pointer;
        font-size: 18px;
        padding: 5px;
    }
    
    /* Features list */
    .features-list {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 25px;
        margin-top: 30px;
    }
    
    .features-list h4 {
        color: #2c3e50;
        margin-bottom: 15px;
        font-size: 16px;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .features-list ul {
        list-style: none;
        padding-left: 0;
    }
    
    .features-list li {
        padding: 8px 0;
        color: #495057;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .features-list li:before {
        content: '‚úì';
        color: #4CAF50;
        font-weight: bold;
    }
    
    /* Animations */
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
        20%, 40%, 60%, 80% { transform: translateX(5px); }
    }
    
    .shake {
        animation: shake 0.5s ease;
    }
    
    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
    }
    
    .loading {
        animation: pulse 1.5s infinite;
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
        .password-container {
            padding: 20px;
        }
        
        .password-body {
            padding: 30px 20px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="password-container">
    <div class="password-card">
        <div class="password-header">
            <div class="password-icon">üîí</div>
            <div class="password-title">Private Room</div>
            <div class="password-subtitle">Enter password to join this room</div>
        </div>
        
        <div class="password-body">
            <div class="room-info">
                <h3>üîí {{ room_name|default:"Private Room" }}</h3>
                <div class="room-details">
                    <p><strong>Room ID:</strong> {{ room_id }}</p>
                    {% if is_short_code %}
                    <p><strong>Type:</strong> Short Code Room</p>
                    {% else %}
                    <p><strong>Type:</strong> Private Room</p>
                    {% endif %}
                    
                    <!-- Add user status notices -->
                    {% if user.is_authenticated and user == room.created_by %}
                    <div class="creator-notice">
                        ‚úÖ <strong>You created this room!</strong> As the creator, you have automatic access.
                    </div>
                    {% elif user.is_authenticated %}
                    <div class="logged-in-notice">
                        ‚úÖ You are logged in. Once entered, this password will be saved for future access.
                    </div>
                    {% else %}
                    <div class="guest-notice">
                        ‚ö†Ô∏è You are not logged in. Password will only be remembered for this session.
                    </div>
                    {% endif %}
                </div>
            </div>
            
            {% if error %}
            <div class="error-message">
                <span>‚ö†Ô∏è</span> {{ error }}
            </div>
            {% endif %}
            
            <form method="post" class="password-form" id="password-form">
                {% csrf_token %}
                
                <div class="form-group">
                    <label class="form-label" for="password">
                        <span>üîë</span> Room Password
                    </label>
                    <div class="password-container-field">
                        <input type="password" 
                               name="password" 
                               id="password" 
                               class="form-input" 
                               placeholder="Enter the room password"
                               required
                               autofocus>
                        <button type="button" class="toggle-password-btn" onclick="togglePassword()">
                            üëÅÔ∏è
                        </button>
                    </div>
                </div>

                {% if user.is_authenticated and can_save_password %}
                <label class="remember-checkbox">
                    <input type="checkbox" 
                           name="save_password" 
                           id="save-password"
                           checked>
                    <span class="remember-label">üíæ Save this password for future access</span>
                </label>
                {% endif %}
                
                <button type="button" class="password-btn" id="join-button" onclick="submitPassword()">
                    <span>üö™ Join Room</span>
                </button>
            </form>
            
            <div class="alternative-options">
                <a href="{% url 'rooms' %}">‚Üê Back to Rooms</a>
                <a href="{% url 'index' %}">üè† Home</a>
                {% if not user.is_authenticated %}
                <a href="{% url 'login' %}?next={{ request.path }}">üîê Login to save passwords</a>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Room Features -->
    <div class="features-list">
        <h4><span>‚ú®</span> About Private Rooms</h4>
        <ul>
            <li>Password-protected access for invited users</li>
            <li>Logged-in users can save passwords for future access</li>
            <li>Room creators have automatic access</li>
            <li>Secure, encrypted chat environment</li>
            <li>Media files are deleted after being viewed</li>
            <li>Messages are temporary and auto-delete</li>
        </ul>
    </div>
</div>
<script>
    // Toggle password visibility
    function togglePassword() {
        const passwordInput = document.getElementById('password');
        const toggleButton = document.querySelector('.toggle-password-btn');
        
        if (!passwordInput || !toggleButton) {
            console.error('Password input or toggle button not found');
            return;
        }
        
        if (passwordInput.type === 'password') {
            passwordInput.type = 'text';
            toggleButton.innerHTML = 'üôà';
            toggleButton.title = 'Hide password';
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                if (passwordInput.type === 'text') {
                    passwordInput.type = 'password';
                    toggleButton.innerHTML = 'üëÅÔ∏è';
                    toggleButton.title = 'Show password';
                }
            }, 5000);
        } else {
            passwordInput.type = 'password';
            toggleButton.innerHTML = 'üëÅÔ∏è';
            toggleButton.title = 'Show password';
        }
        
        // Keep focus on password field
        passwordInput.focus();
        if (passwordInput.setSelectionRange) {
            passwordInput.setSelectionRange(passwordInput.value.length, passwordInput.value.length);
        }
    }

    // Initialize toggle button on page load
    document.addEventListener('DOMContentLoaded', function() {
        const passwordInput = document.getElementById('password');
        if (!passwordInput) {
            console.error('Password input field not found');
            return;
        }
        
        const formGroup = passwordInput.parentElement;
        if (!formGroup) {
            console.error('Form group not found');
            return;
        }
        
        // Check if button already exists
        if (formGroup.querySelector('.toggle-password-btn')) {
            console.log('Toggle button already exists');
            return;
        }
        
        // Create toggle button
        const toggleButton = document.createElement('button');
        toggleButton.type = 'button';
        toggleButton.className = 'toggle-password-btn';
        toggleButton.innerHTML = 'üëÅÔ∏è';
        toggleButton.title = 'Show password';
        toggleButton.style.cssText = `
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #6c757d;
            cursor: pointer;
            font-size: 18px;
            padding: 5px;
            z-index: 10;
            outline: none;
            transition: color 0.3s;
        `;
        
        // Add click event
        toggleButton.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            togglePassword();
        });
        
        // Hover effects
        toggleButton.addEventListener('mouseenter', function() {
            this.style.color = '#4CAF50';
        });
        
        toggleButton.addEventListener('mouseleave', function() {
            this.style.color = '#6c757d';
        });
        
        // Make form group positioned relative
        formGroup.style.position = 'relative';
        
        // Append button to form group
        formGroup.appendChild(toggleButton);
        
        console.log('Toggle button created and added');
        
        // Auto-focus on password field
        passwordInput.focus();
        
        // Check if password was previously attempted from session
        const previousAttempt = sessionStorage.getItem(`password_attempt_${getRoomId()}`);
        if (previousAttempt) {
            passwordInput.value = previousAttempt;
            passwordInput.select();
        }
    });

    // Helper function to get CSRF token
    function getCsrfToken() {
        const csrfTokenElement = document.querySelector('[name=csrfmiddlewaretoken]');
        return csrfTokenElement ? csrfTokenElement.value : '';
    }

    // Get room ID from context
    function getRoomId() {
        // First try to get from the page context
        const roomIdFromContext = "{{ room_id|safe }}";
        if (roomIdFromContext && roomIdFromContext !== "room_id") {
            return roomIdFromContext;
        }
        
        // If not in context, try to extract from URL
        const urlParams = new URLSearchParams(window.location.search);
        const roomIdParam = urlParams.get('room_id');
        if (roomIdParam) {
            return roomIdParam;
        }
        
        // Last resort: check URL path
        const pathSegments = window.location.pathname.split('/');
        for (let segment of pathSegments) {
            if (segment && segment.length > 0) {
                // Could be UUID (36 chars with hyphens) or short code (6 chars)
                if (segment.length === 36 && segment.includes('-')) {
                    // Looks like a UUID
                    return segment;
                } else if (segment.length === 6) {
                    // Looks like a short code
                    return segment;
                } else if (segment.length > 10 && segment.length < 36) {
                    // Could be a short code or other identifier
                    return segment;
                }
            }
        }
        
        console.error('Could not determine room ID from URL:', window.location.pathname);
        return null;
    }

    // Submit password via AJAX
    async function submitPassword() {
        const password = document.getElementById('password').value.trim();
        const savePassword = document.getElementById('save-password')?.checked || false;
        const joinBtn = document.getElementById('join-button');
        const roomId = getRoomId();

        if (!password) {
            showError('Please enter the room password.');
            return false;
        }

        if (!roomId) {
            showError('Cannot determine room ID. Please try accessing the room again.');
            return false;
        }

        // Show loading state
        const originalText = joinBtn.innerHTML;
        joinBtn.innerHTML = `
            <span class="loading-spinner"></span> Verifying...
        `;
        joinBtn.disabled = true;
        joinBtn.classList.add('loading');

        try {
            // First, let's debug the URL we're calling
            const verifyUrl = `/verify-room-password/${roomId}/`;
            console.log('Attempting to verify password at:', verifyUrl);
            
            // Send password verification request
            const formData = new FormData();
            formData.append('password', password);
            formData.append('remember', savePassword);
            formData.append('csrfmiddlewaretoken', getCsrfToken());

            const verifyResponse = await fetch(verifyUrl, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });

            // Try to get the response as text first for debugging
            const responseText = await verifyResponse.text();
            console.log('Raw response text:', responseText);

            let verifyData;
            try {
                verifyData = JSON.parse(responseText);
            } catch (e) {
                console.error('Failed to parse JSON response:', e);
                showError('Server returned invalid response. Please try again.');
                joinBtn.innerHTML = originalText;
                joinBtn.disabled = false;
                joinBtn.classList.remove('loading');
                return;
            }

            if (verifyData.success) {
                // Password is correct
                joinBtn.innerHTML = `
                    <span style="margin-right: 8px;">‚úÖ</span>
                    Access granted! Redirecting...
                `;

                // Small delay to show success message
                setTimeout(() => {
                    if (verifyData.redirect_url) {
                        window.location.href = verifyData.redirect_url;
                    } else {
                        // Fallback redirect
                        window.location.href = "/chat/" + roomId + "/";
                    }
                }, 1500);
                
            } else {
                // Show error from server
                showError(verifyData.error || 'Incorrect password');
                joinBtn.innerHTML = originalText;
                joinBtn.disabled = false;
                joinBtn.classList.remove('loading');
                
                // Clear password field on error
                document.getElementById('password').value = '';
                document.getElementById('password').focus();
            }
            
        } catch (error) {
            console.error('Error details:', error);
            
            // More specific error messages
            if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
                showError('Cannot connect to server. Please check your internet connection.');
            } else {
                showError('Error: ' + error.message);
            }
            
            joinBtn.innerHTML = originalText;
            joinBtn.disabled = false;
            joinBtn.classList.remove('loading');
        }
    }

    // Show error message
    function showError(message) {
        // Remove existing error
        const existingError = document.querySelector('.error-message:not([data-original])');
        if (existingError) {
            existingError.remove();
        }
        
        // Create new error message
        const errorDiv = document.createElement('div');
        errorDiv.className = 'error-message';
        errorDiv.innerHTML = `<span style="font-size: 18px;">‚ö†Ô∏è</span> ${message}`;
        
        // Insert after room info
        const roomInfo = document.querySelector('.room-info');
        if (roomInfo) {
            roomInfo.parentNode.insertBefore(errorDiv, roomInfo.nextSibling);
        } else {
            // If no room info, insert after password form
            const passwordForm = document.querySelector('.password-form');
            if (passwordForm) {
                passwordForm.parentNode.insertBefore(errorDiv, passwordForm.nextSibling);
            }
        }
        
        // Add shake animation to password field
        const passwordField = document.getElementById('password');
        if (passwordField) {
            passwordField.classList.add('shake');
            setTimeout(() => passwordField.classList.remove('shake'), 500);
        }
        
        // Scroll to error
        errorDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });

        // Focus on password field
        if (passwordField) {
            passwordField.focus();
        }
    }

    // Handle Enter key in password field
    document.addEventListener('DOMContentLoaded', function() {
        const passwordField = document.getElementById('password');
        if (passwordField) {
            passwordField.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    // Save attempt to session storage
                    sessionStorage.setItem(`password_attempt_${getRoomId()}`, this.value);
                    submitPassword();
                }
            });
        }
        
        // Handle Escape key to go back
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                e.preventDefault();
                if (confirm('Leave password entry? You will return to the rooms page.')) {
                    window.location.href = "{% url 'rooms' %}";
                }
            }
            
            // Ctrl/Cmd + Enter to submit
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                submitPassword();
            }
            
            // Tab to navigate fields
            if (e.key === 'Tab') {
                const inputs = document.querySelectorAll('.form-input');
                const currentIndex = Array.from(inputs).indexOf(document.activeElement);
                
                if (currentIndex < inputs.length - 1) {
                    e.preventDefault();
                    inputs[currentIndex + 1].focus();
                }
            }
        });
        
        // Handle form submission (prevent default)
        const passwordForm = document.getElementById('password-form');
        if (passwordForm) {
            passwordForm.addEventListener('submit', function(e) {
                e.preventDefault();
                submitPassword();
            });
        }
        
        // Auto-submit if there's a demo password in URL (for development)
        const urlParams = new URLSearchParams(window.location.search);
        const demoPassword = urlParams.get('demo_pass');
        if (demoPassword && (window.location.hostname.includes('localhost') || 
                             window.location.hostname === '127.0.0.1')) {
            if (passwordField) {
                passwordField.value = demoPassword;
                // Small delay to show the auto-filled password
                setTimeout(() => {
                    submitPassword();
                }, 800);
            }
        }
        
        // Check for URL parameters that might affect behavior
        const urlParams2 = new URLSearchParams(window.location.search);
        const expired = urlParams2.get('expired');
        
        if (expired === 'true') {
            showError('Your room access has expired. Please enter the password again.');
        }
    });

    // Input field effects
    document.addEventListener('DOMContentLoaded', function() {
        const passwordInput = document.getElementById('password');
        if (passwordInput) {
            passwordInput.addEventListener('focus', function() {
                this.parentElement.style.transform = 'translateY(-2px)';
            });
            
            passwordInput.addEventListener('blur', function() {
                this.parentElement.style.transform = 'translateY(0)';
            });
        }
    });

    // Quick access buttons for development
    if (window.location.hostname.includes('localhost') || 
        window.location.hostname.includes('127.0.0.1')) {
        
        const devButtons = document.createElement('div');
        devButtons.style.cssText = `
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 9999;
        `;
        
        // You can add development buttons here if needed
        // For example: auto-fill common passwords, etc.
    }
</script>
{% endblock %}